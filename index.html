<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>業務実績ダッシュボード</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .tooltip { opacity: 0; position: absolute; transition: opacity 0.3s; pointer-events: none; background-color: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 12px; font-size: 12px; min-width: 220px; z-index: 10; }
        .chart-container svg { width: 100%; height: auto; }
        .legend-item { display: flex; align-items: center; margin-right: 12px; margin-bottom: 4px; font-size: 12px; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; margin-right: 6px; }
        .grid-lines .domain { stroke: none; }
        .horizontal-grid line { stroke: #e5e7eb; stroke-opacity: 0.7; shape-rendering: crispEdges; }
        .vertical-grid line { stroke: #d1d5db; stroke-opacity: 1; shape-rendering: crispEdges; }
        #donut-center-text-val { font-size: 2.5em; font-weight: bold; fill: #111827; }
        #donut-center-text-label { font-size: 1em; fill: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto space-y-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 text-center">工程開発_加工室　作業実績</h1>
        <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 space-y-12">
            <div>
                <header class="mb-6"><h2 class="text-2xl sm:text-3xl font-bold text-gray-900">全体・月次サマリー</h2></header>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                    <div class="order-1">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">全体カテゴリ割合</h3>
                        <div id="overall-category-chart" class="chart-container w-full max-w-md mx-auto"></div>
                    </div>
                    <div class="order-2 space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">月別 依頼件数</h3>
                            <div id="monthly-count-chart" class="chart-container w-full"></div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">月別 カテゴリ内訳</h3>
                            <div id="monthly-category-chart" class="chart-container w-full"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-8"><div id="category-legend" class="flex flex-wrap justify-center mt-4"></div></div>
            </div>
            <hr class="border-gray-200">
            <div>
                <header class="mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">アイテム別 合計作業人日</h2>
                    <p class="text-gray-600 mt-1">アイテムごとの合計作業人日とカテゴリ内訳です。（型番を無視して集計）</p>
                </header>
                <div id="item-summary-chart" class="chart-container w-full"></div>
            </div>
            <hr class="border-gray-200">
            <div>
                <header class="mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">業務実績：依頼期間ガントチャート</h2>
                    <p class="text-gray-600 mt-1">各バーをホバーすると詳細データが表示されます。（開始日順）</p>
                </header>
                <div id="gantt-chart-container" class="chart-container w-full"></div>
            </div>
        </div>
    </div>
    <div id="tooltip" class="tooltip"></div>

    <script>
        async function fetchDataFromAPI(apiUrl) {
            try {
                const url = `${apiUrl}?t=${new Date().getTime()}`;
                const response = await fetch(url);
                if (!response.ok) { throw new Error('APIの読み込みに失敗しました。'); }
                return await response.json();
            } catch (error) {
                console.error('データ取得エラー:', error);
                document.body.innerHTML = `<div class="text-center p-8"><p class="text-red-600 font-bold">${error.message}</p></div>`;
                return null;
            }
        }

        function parseData(jsonData) {
            return jsonData.map(item => {
                const itemStr = item['アイテム'] || '-';
                const obj = {
                    依頼番号: item['依頼番号'], 開始日: item['開始日'], 完了日: item['完了日'],
                    総日数: parseFloat(item['総日数']) || 0, 作業人日: parseFloat(item['作業人日']) || 0,
                    カテゴリ: item['カテゴリ'] || '不明', アイテム: itemStr, 型番: item['型番'],
                    依頼部署: item['依頼部署'] || '不明', cleanItem: getCleanItemName(itemStr),
                    month: item['開始日'] ? new Date(item['開始日']).toISOString().substring(0, 7) : '不明',
                    startDate: new Date(item['開始日']),
                    endDate: new Date(new Date(item['完了日']).getTime() + (24 * 60 * 60 * 1000))
                };
                if (isNaN(obj.startDate.getTime())) return null;
                return obj;
            }).filter(d => d !== null);
        }

        const tooltip = d3.select("#tooltip");
        function showTooltip(event, content) {
            tooltip.style("opacity", 1).html(content);
            const tooltipNode = tooltip.node();
            const containerNode = d3.select('body').node();
            let left = event.pageX + 15; let top = event.pageY - 15;
            if (left + tooltipNode.offsetWidth > containerNode.clientWidth) { left = event.pageX - tooltipNode.offsetWidth - 15; }
            if (top + tooltipNode.offsetHeight > containerNode.clientHeight) { top = event.pageY - tooltipNode.offsetHeight; }
            if (top < 0) { top = event.pageY + 15; }
            tooltip.style("left", `${left}px`).style("top", `${top}px`);
        }
        function hideTooltip() { tooltip.style("opacity", 0); }
        function getCleanItemName(itemStr) {
            const patterns = [
                { pattern: /(ねしずえ\(\d+次\))/, name: 'ねしずえ(n次)' }, { pattern: /(ねソニック\(\d+次\))/, name: 'ねソニック(n次)' },
                { pattern: /(ねリヴァイ\(\d+次\))/, name: 'ねリヴァイ(n次)' }, { pattern: /(Mかにクレーン\(\d+次\))/, name: 'Mかにクレーン(n次)' },
                { pattern: /(ねハンジ\(再\))/, name: 'ねハンジ(再)' }, { pattern: /(ね太宰\(\d+次\))/, name: 'ね太宰(n次)' },
                { pattern: /(ねアルフォンス\(\d+次\))/, name: 'ねアルフォンス(n次)' }, { pattern: /(ねエドワード\(\d+次\))/, name: 'ねエドワード(n次)' },
                { pattern: /(SCイレイナ\(再\))/, name: 'SCイレイナ(再)' }, { pattern: /(Mバルディ\(再\))/, name: 'Mバルディ(再)' },
                { pattern: /(ね桜ミク\(再\))/, name: 'ね桜ミク(再)' }, { pattern: /(Hbオベロン3rd)/, name: 'Hbオベロン3rd' },
                { pattern: /(Hbセバスチャン)/, name: 'Hbセバスチャン' }, { pattern: /(Hbスニーカーroot)/, name: 'Hbスニーカーroot' },
                { pattern: /(ジャック共通ベース|モスマン共通ベース)/, name: 'ジャック共通ベース' }, { pattern: /(archGirlアーキタイプ)/, name: 'archGirlアーキタイプ' },
                { pattern: /(ねど碇シンジ)/, name: 'ねど碇シンジ' }, { pattern: /(シンプルスタンド|Simpタワータイプ)/, name: 'シンプルスタンド' },
                { pattern: /(スライムフィールドベース)/, name: 'スライムフィールドベース' }, { pattern: /(ね展示用パーカー)/, name: 'ね展示用パーカー' },
                { pattern: /(ジャックプラモ共用金型)/, name: 'ジャックプラモ共用金型' }, { pattern: /(デモニホプラモ共用金型)/, name: 'デモニホプラモ共用金型' },
                { pattern: /(ねんどろFM|フェイスメーカー鼻あり)/, name: 'フェイスメーカー/FM' }, { pattern: /(PAジュピター)/, name: 'PAジュピター' },
                { pattern: /(特典)/, name: '特典' },
            ];
            if (typeof itemStr !== 'string') return '不明';
            for (const p of patterns) { if (p.pattern.test(itemStr))
